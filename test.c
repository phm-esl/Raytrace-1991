#include "types.h"
#include "toolbox.h"
#include <stdio.h>
#include <stdlib.h> // calloc malloc(3)
#include <unistd.h> // write(2)

/*
+-------------------------------------------------------------------------------
|
| Test the Trace() routine.
|
+-------------------------------------------------------------------------------
*/

void *Physbase();
void pixel();
void write_pbm_p4();
void PrtTriangle();

int Width = 640;
int Height = 400;

int main() {

  extern FLT focal; // value loaded from input data file

  int x, y;		/* Screen coordinates */
  RAY ray;		/* Primary ray */
  COLOUR colour;
  unsigned char monochrome;
  FLT t;		/* result of Trace() */
  VEC direction;	/* Direction of the primary ray */

  FILE *fp;

  char *screen;
  int X0 = Width >> 1;
  int Y0 = Height >> 1;

  int line = Width >> 3;
  if (Width & 7) line ++;
  screen = (char *)calloc(sizeof(char),line * Height);
  fprintf(stderr,"screen = %lX\n",(unsigned long)screen);

  get_obj("box.obj");
  fprintf(stderr,"loaded object data\n");

  fprintf(stdout,
    "P7\n"
    "WIDTH %d\n"
    "HEIGHT %d\n"
    "DEPTH 1\n"
    "MAXVAL 64\n"
    "TUPLTYPE GRAYSCALE\n"
    "ENDHDR\n",
    Width,Height); //, 1<<(8*sizeof(monochrome))); 

  fprintf(stderr,"sizeof(monochrome) = %lu\n",sizeof(monochrome));

  for (y = Height ; --y >= 0 ;) {
    for (x = 0 ; x < Width; x++) {

      direction[0] = (FLT)(x - X0);
      direction[1] = (FLT)(y - Y0); // begin at top left of screen bitmap
      direction[2] = focal;

      VecUnit(ray.Dir, direction);

      t = Trace(colour, &ray);

      monochrome = (unsigned char)(colour[0]+colour[1]+colour[2]);

      pixel(screen, x, Height - 1 - y, (int)monochrome);
      fwrite(&monochrome,sizeof(unsigned char),1,stdout);
      }
    }
  PrtTriangle();

  write_pbm_p4("raytrace.pbm",Width,Height,screen);
  free(screen);
  }


/*
+-------------------------------------------------------------------------------
|
|
|
+-------------------------------------------------------------------------------
*/

char pix[] = {
  128, 64, 32, 16, 8, 4, 2, 1
  };

char dither[] = {	/* 8x8 dither patterns */
  0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x80,0x00,0x00,0x00,0x08,0x00,0x00,0x00,
  0x88,0x00,0x00,0x00,0x08,0x00,0x00,0x00,
  0x88,0x00,0x00,0x00,0x88,0x00,0x00,0x00,
  0x88,0x00,0x20,0x00,0x88,0x00,0x00,0x00,
  0x88,0x00,0x20,0x00,0x88,0x00,0x02,0x00,
  0x88,0x00,0x22,0x00,0x88,0x00,0x02,0x00,
  0x88,0x00,0x22,0x00,0x88,0x00,0x22,0x00, /* 7 = 12.5% */
  0xa8,0x00,0x22,0x00,0x88,0x00,0x22,0x00,
  0xa8,0x00,0x22,0x00,0x8a,0x00,0x22,0x00,
  0xaa,0x00,0x22,0x00,0x8a,0x00,0x22,0x00,
  0xaa,0x00,0x22,0x00,0xaa,0x00,0x22,0x00,
  0xaa,0x00,0xa2,0x00,0xaa,0x00,0x22,0x00,
  0xaa,0x00,0xa2,0x00,0xaa,0x00,0x2a,0x00,
  0xaa,0x00,0xaa,0x00,0xaa,0x00,0x2a,0x00,
  0xaa,0x00,0xaa,0x00,0xaa,0x00,0xaa,0x00, /* 15 = 25% */
  0xaa,0x40,0xaa,0x00,0xaa,0x00,0xaa,0x00,
  0xaa,0x40,0xaa,0x00,0xaa,0x04,0xaa,0x00,
  0xaa,0x44,0xaa,0x00,0xaa,0x04,0xaa,0x00,
  0xaa,0x44,0xaa,0x00,0xaa,0x44,0xaa,0x00,
  0xaa,0x44,0xaa,0x10,0xaa,0x44,0xaa,0x00,
  0xaa,0x44,0xaa,0x10,0xaa,0x44,0xaa,0x01,
  0xaa,0x44,0xaa,0x11,0xaa,0x44,0xaa,0x01,
  0xaa,0x44,0xaa,0x11,0xaa,0x44,0xaa,0x11, /* 23 = 37.5% */
  0xaa,0x54,0xaa,0x11,0xaa,0x44,0xaa,0x11,
  0xaa,0x54,0xaa,0x11,0xaa,0x45,0xaa,0x11,
  0xaa,0x55,0xaa,0x11,0xaa,0x45,0xaa,0x11,
  0xaa,0x55,0xaa,0x11,0xaa,0x55,0xaa,0x11,
  0xaa,0x55,0xaa,0x51,0xaa,0x55,0xaa,0x11,
  0xaa,0x55,0xaa,0x51,0xaa,0x55,0xaa,0x15,
  0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x15,
  0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55, /* 31 = 50% */
  0xea,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,
  0xea,0x55,0xaa,0x55,0xae,0x55,0xaa,0x55,
  0xee,0x55,0xaa,0x55,0xae,0x55,0xaa,0x55,
  0xee,0x55,0xaa,0x55,0xee,0x55,0xaa,0x55,
  0xee,0x55,0xba,0x55,0xee,0x55,0xaa,0x55,
  0xee,0x55,0xba,0x55,0xee,0x55,0xab,0x55,
  0xee,0x55,0xbb,0x55,0xee,0x55,0xab,0x55,
  0xee,0x55,0xbb,0x55,0xee,0x55,0xbb,0x55, /* 39 = 62.5% */
  0xfe,0x55,0xbb,0x55,0xee,0x55,0xbb,0x55,
  0xfe,0x55,0xbb,0x55,0xef,0x55,0xbb,0x55,
  0xff,0x55,0xbb,0x55,0xef,0x55,0xbb,0x55,
  0xff,0x55,0xbb,0x55,0xff,0x55,0xbb,0x55,
  0xff,0x55,0xfb,0x55,0xff,0x55,0xbb,0x55,
  0xff,0x55,0xfb,0x55,0xff,0x55,0xbf,0x55,
  0xff,0x55,0xff,0x55,0xff,0x55,0xbf,0x55,
  0xff,0x55,0xff,0x55,0xff,0x55,0xff,0x55, /* 47 = 75% */
  0xff,0xd5,0xff,0x55,0xff,0x55,0xff,0x55,
  0xff,0xd5,0xff,0x55,0xff,0x5d,0xff,0x55,
  0xff,0xdd,0xff,0x55,0xff,0x5d,0xff,0x55,
  0xff,0xdd,0xff,0x55,0xff,0xdd,0xff,0x55,
  0xff,0xdd,0xff,0x75,0xff,0xdd,0xff,0x55,
  0xff,0xdd,0xff,0x75,0xff,0xdd,0xff,0x57,
  0xff,0xdd,0xff,0x77,0xff,0xdd,0xff,0x57,
  0xff,0xdd,0xff,0x77,0xff,0xdd,0xff,0x77, /* 55 = 87.5% */
  0xff,0xfd,0xff,0x77,0xff,0xdd,0xff,0x77,
  0xff,0xfd,0xff,0x77,0xff,0xdf,0xff,0x77,
  0xff,0xff,0xff,0x77,0xff,0xdf,0xff,0x77,
  0xff,0xff,0xff,0x77,0xff,0xff,0xff,0x77,
  0xff,0xff,0xff,0xf7,0xff,0xff,0xff,0x77,
  0xff,0xff,0xff,0xf7,0xff,0xff,0xff,0x7f,
  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x7f,
  0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff, /* 63 = 100% */
  };

void pixel (screen, x, y, i)
char *screen;
int x, y, i; {
  char d;

  d = ~dither[(i<<3) + (y & 7)];

  if (i > 63)
    d = 0xff;
  if (i < 0)
    d = 0;

  y *= 80;
  y += x >> 3;
  screen[y] |= pix[x & 7] & d;
  }

/*======================== E N D   O F   L I S T I N G =======================*/
